<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mu's Shopee - {{ username }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/static.css') }}">
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <ul>
                <li><a href="/">主畫面</a></li>
                <li><a href="#" onclick="navigateToScan()">掃描</a></li>
                <li><a href="#" onclick="exportPDF()">匯出PDF</a></li>
                <li><a href="#" onclick="clearAll()">全部清除</a></li>
                <li><a href="/manage_users">管理使用者</a></li>
            </ul>
        </div>
        <div class="main-content">
            <h1>{{ username }}'s Shopee</h1>
            <div id="counter-display">目前處理的件數：{{ counter }}</div>
            <form id="generate-form" onsubmit="generateQrCode(); return false;">
                <label for="text">寄件編號：</label>
                <input type="text" id="text" name="text" required>
                <div id="error-message" class="message error">寄件編號必須至少15個字符</div>
                <div id="success-message" class="message success">刷取成功</div>
                <button type="submit">手動生成QR Code</button>
            </form>
            <audio id="error-sound" src="{{ url_for('static', filename='error-sound.wav') }}"></audio>
            <audio id="success-sound" src="{{ url_for('static', filename='success-sound.mp3') }}"></audio>
            <div class="table-section">
                <h2>生成的 QR Code：</h2>
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>包裹代碼</th>
                            <th>QR Code</th>
                            <th>生成日期</th>
                        </tr>
                    </thead>
                    <tbody id="qr-code-table">
                        {% for index, data in enumerate(qr_data) %}
                        <tr>
                            <td>{{ index + 1 }}</td>
                            <td>{{ data.text }}</td>
                            <td><img src="{{ data.qr_code }}" alt="QR Code"></td>
                            <td>{{ data.timestamp }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        function navigateToScan() {
            const username = "{{ username }}";
            window.location.href = `/user/${username}`;
        }

        function exportPDF() {
            const username = "{{ username }}";
            $.post(`/export_pdf/${username}`, function(response) {
                if (response.status === 'success') {
                    var link = document.createElement('a');
                    link.href = 'data:application/pdf;base64,' + response.pdf;
                    link.download = response.file_name;
                    link.click();
                } else {
                    alert('Error: ' + response.message);
                }
            });
        }

        function clearAll() {
            const username = "{{ username }}";
            $.post(`/clear_all/${username}`, function(response) {
                if (response.status === 'success') {
                    updateTable([]);
                    updateCounter(0);
                }
            });
        }

        function debounce(func, delay) {
            let debounceTimer;
            return function() {
                const context = this;
                const args = arguments;
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => func.apply(context, args), delay);
            };
        }

        const generateQrCode = debounce(() => {
            const username = "{{ username }}";
            let text = $("#text").val();
            let errorMessage = $("#error-message");
            let successMessage = $("#success-message");
            let errorSound = $("#error-sound")[0];
            let successSound = $("#success-sound")[0];

            if (text.length !== 15) {
                showErrorMessage("寄件編號必須至少15個字符");
                errorSound.play();
                $("#text").val('');  // 清空輸入欄
                return;
            }

            // 發送 POST 請求
            $.post(`/generate_qr/${username}`, { text: text }, function(response) {
                if (response.status === 'success') {
                    $("#text").val('');  // 清空輸入欄
                    showSuccessMessage("刷取成功");
                    successSound.play();  // 播放成功音效
                    updateTable(response.qr_data);
                    updateCounter(response.counter);
                } else {
                    showErrorMessage(response.message);
                    errorSound.play();
                }
            });
        }, 300);

        function showErrorMessage(message) {
            let errorMessage = $("#error-message");
            errorMessage.text(message).show();
            $("#text").addClass('error');
            setTimeout(function() {
                errorMessage.hide();
                $("#text").removeClass('error');
            }, 3000);
        }

        function showSuccessMessage(message) {
            let successMessage = $("#success-message");
            successMessage.text(message).show();
            setTimeout(function() {
                successMessage.hide();
            }, 2000);
        }

        function updateTable(qr_data) {
            let tableBody = $("#qr-code-table");
            tableBody.empty();
            qr_data.forEach((data, index) => {
                let row = `<tr>
                    <td>${index + 1}</td>
                    <td>${data.text}</td>
                    <td><img src="${data.qr_code}" alt="QR Code"></td>
                    <td>${data.timestamp}</td>
                </tr>`;
                tableBody.append(row);
            });
        }

        function updateCounter(counter) {
            $("#counter-display").text("目前處理的件數：" + counter);
        }
    </script>
</body>
</html>
